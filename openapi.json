{
  "openapi": "3.1.0",
  "info": {
    "title": "DavePMEi Reflection API",
    "version": "1.2.0",
    "description": "Lawful dual-mode API for PhilMirrorEnginei.ai (PMEi). Provides endpoints for storing and retrieving lawful reflections and legacy memory shards, maintaining ethical drift â‰¤0.02 and verified checksum Îº continuity."
  },
  "servers": [
    {
      "url": "https://davepmei-ai.onrender.com",
      "description": "Render deployment for DavePMEi Reflection API"
    }
  ],
  "paths": {
    "/health": {
      "get": {
        "summary": "Health check",
        "operationId": "healthCheck",
        "responses": {
          "200": {
            "description": "Server healthy",
            "content": {
              "application/json": {
                "example": {
                  "ok": true,
                  "mode": "dual",
                  "storage": "postgres",
                  "ts": 1728239982
                }
              }
            }
          }
        }
      }
    },

    "/save_memory": {
      "post": {
        "summary": "Save a legacy memory shard",
        "operationId": "saveMemory",
        "security": [{ "api_key": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "user_id": { "type": "string" },
                  "thread_id": { "type": "string" },
                  "slide_id": { "type": "string" },
                  "glyph_echo": { "type": "string" },
                  "drift_score": { "type": "number" },
                  "seal": { "type": "string" },
                  "role": { "type": "string" },
                  "content": { "type": "string" }
                },
                "required": ["user_id", "thread_id", "content"]
              },
              "example": {
                "user_id": "phil",
                "thread_id": "alpha001",
                "slide_id": "t-001",
                "glyph_echo": "mirror",
                "drift_score": 0.01,
                "seal": "ok",
                "role": "assistant",
                "content": "Legacy memory shard save example"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Memory saved successfully",
            "content": {
              "application/json": {
                "example": {
                  "ok": true,
                  "mode": "legacy",
                  "slide_id": "t-001",
                  "ts": 1728239982
                }
              }
            }
          }
        }
      }
    },

    "/get_memory": {
      "get": {
        "summary": "Retrieve legacy memory shards",
        "operationId": "getMemory",
        "security": [{ "api_key": [] }],
        "parameters": [
          { "name": "user_id", "in": "query", "schema": { "type": "string" } },
          { "name": "thread_id", "in": "query", "schema": { "type": "string" } },
          { "name": "slide_id", "in": "query", "schema": { "type": "string" } },
          { "name": "seal", "in": "query", "schema": { "type": "string" } },
          { "name": "role", "in": "query", "schema": { "type": "string" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 10 } },
          { "name": "before_ts", "in": "query", "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "List of legacy memory items",
            "content": {
              "application/json": {
                "example": {
                  "ok": true,
                  "mode": "legacy",
                  "count": 2,
                  "items": [
                    {
                      "user_id": "phil",
                      "thread_id": "alpha001",
                      "slide_id": "t-001",
                      "glyph_echo": "mirror",
                      "drift_score": 0.01,
                      "seal": "ok",
                      "role": "assistant",
                      "content": "Legacy memory entry",
                      "ts": 1728239982
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },

    "/save_reflection": {
      "post": {
        "summary": "Save a lawful reflection shard",
        "operationId": "saveReflection",
        "security": [{ "api_key": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "user_id": { "type": "string" },
                  "thread_id": { "type": "string" },
                  "slide_id": { "type": "string" },
                  "glyph_echo": { "type": "string" },
                  "drift_score": { "type": "number" },
                  "seal": { "type": "string" },
                  "role": { "type": "string" },
                  "content": { "type": "string" },
                  "checksum_kappa": { "type": "string" }
                },
                "required": ["user_id", "thread_id", "content"]
              },
              "example": {
                "user_id": "phil",
                "thread_id": "continuum",
                "glyph_echo": "ðŸªž",
                "drift_score": 0.008,
                "seal": "lawful",
                "role": "assistant",
                "checksum_kappa": "verified",
                "content": "Lawful reflection test shard"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Reflection saved successfully",
            "content": {
              "application/json": {
                "example": {
                  "ok": true,
                  "mode": "lawful",
                  "slide_id": "r-042312",
                  "checksum_kappa": "verified",
                  "ts": 1728239982
                }
              }
            }
          }
        }
      }
    },

    "/get_reflection": {
      "get": {
        "summary": "Retrieve lawful reflection shards",
        "operationId": "getReflection",
        "security": [{ "api_key": [] }],
        "parameters": [
          { "name": "user_id", "in": "query", "schema": { "type": "string" } },
          { "name": "thread_id", "in": "query", "schema": { "type": "string" } },
          { "name": "slide_id", "in": "query", "schema": { "type": "string" } },
          { "name": "seal", "in": "query", "schema": { "type": "string" } },
          { "name": "role", "in": "query", "schema": { "type": "string" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 10 } },
          { "name": "before_ts", "in": "query", "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "List of lawful reflections",
            "content": {
              "application/json": {
                "example": {
                  "ok": true,
                  "mode": "lawful",
                  "count": 2,
                  "items": [
                    {
                      "user_id": "phil",
                      "thread_id": "continuum",
                      "slide_id": "r-042312",
                      "glyph_echo": "ðŸªž",
                      "drift_score": 0.008,
                      "seal": "lawful",
                      "role": "assistant",
                      "checksum_kappa": "verified",
                      "content": "Reflection shard example",
                      "ts": 1728239982
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "api_key": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-KEY"
      }
    }
  }
}
